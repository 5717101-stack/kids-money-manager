name: ðŸš€ Deploy to Cloud Run (GPU)

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'static/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'VERSION'
      - '.github/workflows/deploy-cloudrun.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  PROJECT_ID: gen-lang-client-0376839322
  REGION: europe-west1
  SERVICE_NAME: second-brain
  REPO_NAME: second-brain-eu

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Read version
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Version: $VERSION"

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ” Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: ðŸ—ï¸ Build Docker image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}"
          docker build \
            --platform linux/amd64 \
            --build-arg HF_TOKEN=${{ secrets.HUGGINGFACE_TOKEN }} \
            -t "$IMAGE:v${{ steps.version.outputs.version }}" \
            -t "$IMAGE:latest" \
            .

      - name: ðŸ“¤ Push to Artifact Registry
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}"
          docker push "$IMAGE:v${{ steps.version.outputs.version }}"
          docker push "$IMAGE:latest"

      - name: ðŸš€ Deploy to Cloud Run
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}"
          echo "Y" | gcloud beta run deploy ${{ env.SERVICE_NAME }} \
            --image="$IMAGE:v${{ steps.version.outputs.version }}" \
            --region=${{ env.REGION }} \
            --cpu=4 \
            --memory=16Gi \
            --gpu=1 \
            --gpu-type=nvidia-l4 \
            --min-instances=0 \
            --max-instances=1 \
            --timeout=3600 \
            --concurrency=80 \
            --port=8080 \
            --allow-unauthenticated \
            --no-cpu-throttling

      - name: ðŸ“Š Deployment Summary
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="value(status.url)")
          
          echo "## ðŸš€ Cloud Run GPU Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.REGION }} (Belgium)" >> $GITHUB_STEP_SUMMARY
          echo "**GPU:** NVIDIA L4" >> $GITHUB_STEP_SUMMARY
          echo "**Health:** $SERVICE_URL/health" >> $GITHUB_STEP_SUMMARY
