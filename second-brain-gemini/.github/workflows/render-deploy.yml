name: ğŸŒ Deploy to Render

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“ Read version
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Deploying version: $VERSION"
      
      - name: ğŸš€ Trigger Render Deployment
        if: env.RENDER_API_KEY != ''
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "âš ï¸  Render API credentials not set. Skipping automatic deployment."
            echo "ğŸ’¡ Render will auto-deploy from GitHub webhook instead."
            exit 0
          fi
          
          echo "ğŸš€ Triggering Render deployment..."
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            || echo "âš ï¸  Render API call failed (this is OK if using webhook deployment)"
      
      - name: ğŸ“Š Deployment Status
        run: |
          echo "## ğŸŒ Render Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ Check your Render dashboard for deployment status" >> $GITHUB_STEP_SUMMARY
      
      - name: â³ Wait for Render to finish deployment
        run: |
          echo "â³ Waiting 3 minutes for Render to complete deployment..."
          sleep 180
      
      - name: ğŸ“± Get commit message for changelog
        id: commit
        run: |
          # Get commit message and escape for JSON
          COMMIT_MSG=$(git log -1 --pretty=%B | head -5)
          # Replace newlines with spaces and escape quotes
          COMMIT_MSG_CLEAN=$(echo "$COMMIT_MSG" | tr '\n' ' ' | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          echo "message=$COMMIT_MSG_CLEAN" >> $GITHUB_OUTPUT
          echo "ğŸ“ Commit message: $COMMIT_MSG_CLEAN"
      
      - name: ğŸ“² Send WhatsApp Deployment Notification
        env:
          VERSION: ${{ steps.version.outputs.version }}
          CHANGES: ${{ steps.commit.outputs.message }}
        run: |
          echo "ğŸ“² Sending deployment notification via WhatsApp..."
          echo "   Version: $VERSION"
          echo "   Changes: $CHANGES"
          
          # Build JSON payload
          JSON_PAYLOAD=$(cat <<EOF
          {
            "version": "${VERSION}",
            "changes": "${CHANGES}",
            "status": "success"
          }
          EOF
          )
          
          echo "   Payload: $JSON_PAYLOAD"
          
          # Send notification
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://second-brain-6q8c.onrender.com/notify-deployment" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "   Response Code: $HTTP_CODE"
          echo "   Response Body: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… WhatsApp notification sent successfully!"
          else
            echo "âš ï¸  Failed to send WhatsApp notification (HTTP $HTTP_CODE)"
          fi
